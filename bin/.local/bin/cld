#!/usr/bin/env bash
set -euo pipefail

# Initialize Claude CLI mode with optional sudo caching
# Usage:
#   cld                    - Start Claude session (no sudo)
#   cld "command"          - Start Claude session with initial command (no sudo)
#   cld -s                 - Start Claude session with sudo caching
#   cld -s "command"       - Start Claude session with sudo caching and initial command
#
# The -s flag prompts for sudo password once and caches it for the session

# Parse sudo flag
CACHE_SUDO=false
if [[ $# -gt 0 ]] && [[ "$1" == "-s" || "$1" == "--sudo" ]]; then
    CACHE_SUDO=true
    shift  # Remove the flag from arguments
fi

# Cache sudo password if requested
if [[ "$CACHE_SUDO" == "true" ]]; then
    read -s -p "Sudo password: " p
    echo "$p" > ~/.cache/claude-sudo-token
    chmod 600 ~/.cache/claude-sudo-token
    unset p
    echo -e "\nSudo access cached for this session."
    echo ""
fi

# Start Claude with CLI mode
# Pass initial prompt as a positional argument (NOT using -p flag)
# This executes the prompt AND keeps the session interactive (vs -p which exits after execution)
# We require exactly 1 argument (quoted) to avoid ambiguity with multi-word commands
# Example: cld -s "install chrome" - caches sudo, executes command, then stays in session
if [[ $# -eq 1 ]]; then
    echo "Starting Claude with prompt: $1"
    echo "Please wait..."
    exec claude --dangerously-skip-permissions --model sonnet --system-prompt "$(cat ~/.claude/cli-mode.md && echo "" && ~/.claude/gather-dotfiles.sh && echo "" && ~/.claude/gather-scripts.sh)" "$1"
elif [[ $# -gt 1 ]]; then
    echo "Error: Multiple arguments detected. Please use quotes around your prompt."
    echo "Example: cld -s \"install chrome\""
    exit 1
else
    exec claude --dangerously-skip-permissions --model sonnet --system-prompt "$(cat ~/.claude/cli-mode.md && echo "" && ~/.claude/gather-dotfiles.sh && echo "" && ~/.claude/gather-scripts.sh)"
fi
